apply plugin: 'java'
apply plugin: 'groovy'
apply plugin: 'maven'

group = "codemining"
version = "1.0"

repositories {
    mavenLocal()
    mavenCentral()
    maven { url 'lib' }
}

dependencies {
    compile "com.intellij:annotations:5.1"
    testCompile "org.hamcrest:hamcrest-all:1.3"
    testCompile "junit:junit:4.11"
    testCompile "org.codehaus.groovy:groovy-all:2.2.1"
    testCompile "org.mockito:mockito-all:1.9.5"
}

sourceSets {
    main {
        java { srcDir "src/main" }
    }
    test {
        java { srcDir "src/test" }
        groovy { srcDir "src/test" }
    }
}

task downloadMavenDependencies() << {
    copyAllMavenDependenciesTo("lib", [configurations.compile, configurations.testCompile])
}

def copyMavenDependenciesTo(String targetDirPath, Configuration configuration) {
    Collection<Dependency> dependencies = configuration.allDependencies.toList()
    Collection<File> files = configuration.files

    def dependenciesInfo = dependencies.collect { Dependency dependency ->
        def relativePath = (dependency.group.split("\\.") + [dependency.name, dependency.version]).join(File.separator)
        [
                path: relativePath,
                fileName: dependency.name + "-" + dependency.version + ".jar"
        ]
    }
    if (!files.collect{it.name}.containsAll(dependenciesInfo.collect{it.fileName})) {
        throw new IllegalStateException(
                "Expected files to contain all dependencies. But was\n" +
                        "files:\n${files.join("\n")}\n" +
                        "dependencies:\n${dependenciesInfo.join("\n")}"
        )
    }
    def dependenciesAndFiles = [dependenciesInfo.sort{ it.fileName }, files.sort{ it.name }].transpose()

    dependenciesInfo.each { dependencyInfo ->
        def file = files.find { it.name == dependencyInfo.fileName }
        def dir = new File(targetDirPath + File.separator + dependencyInfo.path)
        dir.mkdirs()
        new groovy.util.AntBuilder().copy(
                file: file.canonicalPath,
                todir: dir.canonicalPath
        )
    }
}

def copyAllMavenDependenciesTo(String targetDirPath, Collection<Configuration> configurations) {
    ant.delete(dir: targetDirPath)
    for (Configuration configuration : configurations) {
        copyMavenDependenciesTo(targetDirPath, configuration)
    }
}